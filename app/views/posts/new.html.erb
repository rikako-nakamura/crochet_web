<div class="container px-5 py-24 mx-auto">
  <div class="flex flex-col w-full mb-15 bg-pink-100">
    <%= image_tag "flower2.png"%>
    <h1 class="text-3xl font-medium title-font mb-4 text-gray-900 font-body text-center">Let's post your work</h1>
    <p class="lg:w-2/3 mx-auto leading-relaxed text-base font-body text-lg text-center">
      かぎ針で編んだ作品を投稿してアイデアや配色を共有しましょう🌷
    </p>
    <%= image_tag "flower2.png"%>
  </div>

  <section class="text-gray-600 body-font overflow-hidden">
    <div class= "justify-center">
      <%= form_with model: @post, local: true do |f| %>
        <div class="lg:w-full mx-auto flex flex-wrap">
          <div class="form-group lg:w-1/2 w-full lg:pl-10 lg:py-6 my-auto">
            <%= f.hidden_field :post_image_cache %>
            <div class='mt-3 mb-3 w-full' id= 'preview' size= '100x100'></div>
          </div>
          <div class="lg:w-1/2 w-full lg:pl-10 lg:py-6 my-auto font-body">
            <div class="lg:w-1/2 w-full lg:pl-10 lg:py-6 mt-6 lg:mt-0">
              <%= f.label :post_image, t('.post_image'), class: 'text-gray-600 h-10 pr-10 bg-white font-body' %>
              <%= f.file_field :post_image, onChange: "imgPreView(event)", class: 'text-sm text-gray-500', required: true %>
              <div class="form-group inline-block mt-3">
                <%= f.label :category_id, 'カテゴリ' %>
                <div class="border border-gray-300 rounded-full text-gray-600 h-10 pl-5 pr-10 bg-white hover:border-gray-400 focus:outline-none appearance-none font-body">
                  <%= f.collection_select :category_id, @categories, :id, :name, { include_blank: '選択してください'}, { class: 'form-control py-1' , required: true } %>
                </div>
              </div>
              <div class="form-group inline-block mt-3">
                <%= f.label :mood_id, 'イメージ' %>
                <div class="border border-gray-300 rounded-full text-gray-600 h-10 pl-5 pr-10 bg-white hover:border-gray-400 focus:outline-none appearance-none font-body">
                  <%= f.collection_select :mood_id, @moods, :id, :name, { include_blank: '選択してください'}, { class: 'form-control py-1' , required: true } %>
                </div>
              </div>

              <div class="form-group inline-block mt-3">
                <%= f.label :finished_at, "作品にかかった時間はどのくらいですか？" %>
                <%= f.text_field :finished_at, placeholder: "(例)およそ1日", class: 'inline-flex border border-gray-300 rounded-full text-gray-600 h-10 pl-5 pr-10 bg-white hover:border-gray-400 focus:outline-none appearance-none font-body' %>
              </div>

              <div class="form-group inline-block mt-3">
                <%= f.label :body, "ひとこと(任意)" %>
                <%= f.text_area :body, class: 'w-full bg-white rounded-lg border border-gray-300 focus:border-green-500 focus:ring-2 focus:ring-green-200 h-32 text-base outline-none text-gray-700 py-1 px-3 resize-none leading-6 transition-colors duration-200 ease-in-out"' %>
              </div>

            <div class="flex mt-3">
              <%= f.submit class: 'flex ml-auto text-gray-700 bg-pink-200 border-0 py-2 px-6 focus:outline-none hover:bg-pink-500 rounded' %>
            </div>
          </div>
        </div>
      <%end%>
    </div>
  </section>
</div>
<script>
  function imgPreView(event) {
  var file = event.target.files[0];
  var reader = new FileReader();
  var preview = document.getElementById("preview");
  var previewImage = document.getElementById("previewImage");

  if(previewImage != null) {
    preview.removeChild(previewImage);
  }
  reader.onload = function(event) {
    var img = document.createElement("img");
    img.setAttribute("src", reader.result);
    img.setAttribute("id", "previewImage");
    preview.appendChild(img);
  };

  reader.readAsDataURL(file);
  }
</script>

<script>
$(function() {
  $('.directUpload').find("input:file").each(function(i, elem) {
    var fileInput    = $(elem);
    var form         = $(fileInput.parents('form:first'));
    var submitButton = form.find('input[type="submit"]');
    var progressBar  = $("<div class='bar'></div>");
    var barContainer = $("<div class='progress'></div>").append(progressBar);
    fileInput.after(barContainer);
    fileInput.fileupload({
      fileInput:       fileInput,
      url:             form.data('url'),
      type:            'POST',
      autoUpload:       true,
      formData:         form.data('form-data'),
      paramName:        'file', // S3 does not like nested name fields i.e. name="user[avatar_url]"
      dataType:         'XML',  // S3 returns XML if success_action_status is set to 201
      replaceFileInput: false,
      progressall: function (e, data) {
        var progress = parseInt(data.loaded / data.total * 100, 10);
        progressBar.css('width', progress + '%')
      },
      start: function (e) {
        submitButton.prop('disabled', true);

        progressBar.
          css('background', 'green').
          css('display', 'block').
          css('width', '0%').
          text("Loading...");
      },
      done: function(e, data) {
        submitButton.prop('disabled', false);
        progressBar.text("Uploading done");

        // extract key and generate URL from response
        var key   = $(data.jqXHR.responseXML).find("Key").text();
        var url   = '//' + form.data('host') + '/' + key;

        // create hidden field
        var input = $("<input />", { type:'hidden', name: fileInput.attr('name'), value: url })
        form.append(input);
      },
      fail: function(e, data) {
        submitButton.prop('disabled', false);

        progressBar.
          css("background", "red").
          text("Failed");
      }
    });
  });
});
</script>